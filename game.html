<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower Troll Online</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Press Start 2P', cursive; overflow: hidden; touch-action: none; }
        
        /* UI Katmanları */
        #ui-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .card { background: #222; padding: 20px; border: 4px solid #fff; text-align: center; width: 85%; max-width: 400px; }
        input { width: 80%; padding: 10px; margin: 10px 0; font-family: inherit; text-align: center; border: 2px solid #fff; background: #000; color: #0f0; }
        button { width: 100%; padding: 15px; margin: 10px 0; font-family: inherit; cursor: pointer; background: #fff; color: #000; border: none; font-size: 10px; }
        
        .hidden { display: none !important; }

        /* Oyun Alanı */
        #main-container { display: flex; width: 100%; height: 100%; }
        #game-zone { flex: 2; position: relative; background: #111; border-right: 4px solid #333; }
        canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* Rakipler ve Troll Paneli */
        #sidebar { flex: 1; background: #000; display: flex; flex-direction: column; padding: 5px; gap: 5px; }
        .opp-slot { flex: 1; background: #111; border: 2px solid #333; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .opp-bar { width: 100%; background: #f00; transition: height 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: absolute; bottom: 0; }
        .opp-name { font-size: 8px; position: absolute; top: 5px; z-index: 10; text-align: center; width: 100%; color: #fff; text-shadow: 1px 1px #000; }
        .troll-btn { position: absolute; top: 20px; background: #ff0; color: #000; padding: 5px; font-size: 8px; border: 1px solid #000; z-index: 20; cursor: pointer; width: 80%; text-align: center; }

        /* Mobil Kontroller */
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 1000; pointer-events: none; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; pointer-events: auto; user-select: none; }

        #troll-count { position: absolute; top: 10px; left: 10px; font-size: 8px; color: #ff0; z-index: 1000; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="menu" class="card">
        <h3>TOWER TROLL</h3>
        <input type="text" id="nick" placeholder="ADIN" maxlength="8">
        <button onclick="initPeer('host')">ODA KUR</button>
        <button onclick="showJoin()">ODAYA KATIL</button>
    </div>

    <div id="lobby" class="card hidden">
        <h3>ODA KODU</h3>
        <h1 id="room-code" style="color:#0f0">----</h1>
        <p id="p-count" style="font-size:10px">OYUNCU: 1/4</p>
        <button onclick="startMatch()">BAŞLAT</button>
    </div>

    <div id="join-screen" class="card hidden">
        <h3>KODU GİR</h3>
        <input type="text" id="join-id" placeholder="4 HANELİ KOD">
        <button onclick="initPeer('join')">KATIL</button>
    </div>
</div>

<div id="main-container">
    <div id="game-zone">
        <div id="troll-count">TROLL HAKKI: 3</div>
        <canvas id="canvas"></canvas>
        <div id="controls">
            <div class="btn" id="left">◀</div>
            <div class="btn" id="down">▼</div>
            <div class="btn" id="right">▶</div>
        </div>
    </div>
    <div id="sidebar">
        <div class="opp-slot" id="slot-0"><div class="opp-name">BOŞ</div><div class="troll-btn hidden" onclick="troll(0)">TROLLE!</div><div class="opp-bar"></div></div>
        <div class="opp-slot" id="slot-1"><div class="opp-name">BOŞ</div><div class="troll-btn hidden" onclick="troll(1)">TROLLE!</div><div class="opp-bar"></div></div>
        <div class="opp-slot" id="slot-2"><div class="opp-name">BOŞ</div><div class="troll-btn hidden" onclick="troll(2)">TROLLE!</div><div class="opp-bar"></div></div>
    </div>
</div>

<script>
    let peer, conn, role, myNick;
    let myId, hostId;
    let connections = [];
    let players = {}; // id: {nick, height, trollLeft}
    let trollAmmo = 3;
    let winHeight = 15; // 15 blok yüksekliğe çıkan kazanır (Uzun Mod)
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let blocks = [], currentBlock = null;
    let isGaming = false;

    // --- NETWORK ---
    function showJoin() { document.getElementById('menu').classList.add('hidden'); document.getElementById('join-screen').classList.remove('hidden'); }

    function initPeer(t) {
        role = t;
        myNick = document.getElementById('nick').value || "ADSİZ";
        // 4 haneli kısa sayısal kod üretimi
        let shortId = Math.floor(1000 + Math.random() * 9000).toString();
        
        peer = new Peer(t === 'host' ? shortId : null);
        
        peer.on('open', (id) => {
            myId = id;
            if(t === 'host') {
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('lobby').classList.remove('hidden');
                document.getElementById('room-code').innerText = id;
                players[myId] = {nick: myNick, h: 0};
            } else {
                hostId = document.getElementById('join-id').value;
                let c = peer.connect(hostId);
                setupConn(c);
            }
        });

        peer.on('connection', setupConn);
    }

    function setupConn(c) {
        conn = c;
        c.on('open', () => {
            if(role === 'join') c.send({type: 'join', nick: myNick});
            c.on('data', (data) => {
                if(data.type === 'join') {
                    players[c.peer] = {nick: data.nick, h: 0};
                    updateLobby();
                }
                if(data.type === 'start') beginGame();
                if(data.type === 'sync') { players = data.p; updateBars(); }
                if(data.type === 'troll') { deleteLastBlock(); }
                if(data.type === 'win') { alert("KAZANAN: " + data.n); location.reload(); }
            });
        });
    }

    function updateLobby() {
        let pArray = Object.values(players);
        document.getElementById('p-count').innerText = `OYUNCU: ${pArray.length}/4`;
        if(role === 'host') broadcast({type: 'sync', p: players});
    }

    function broadcast(msg) {
        if(role === 'host') {
            peer._connections.forEach(conns => conns.forEach(c => c.send(msg)));
        } else {
            conn.send(msg);
        }
    }

    // --- TROLL MEKANİĞİ ---
    function troll(slotIdx) {
        if(trollAmmo <= 0) return;
        let pArray = Object.keys(players).filter(id => id !== myId);
        let targetId = pArray[slotIdx];
        if(targetId) {
            trollAmmo--;
            document.getElementById('troll-count').innerText = `TROLL HAKKI: ${trollAmmo}`;
            if(role === 'host') {
                if(targetId === myId) deleteLastBlock(); // Host kendini trollerse (hata payı)
                else peer._connections.get(targetId)[0].send({type: 'troll'});
            } else {
                broadcast({type: 'forward_troll', target: targetId});
            }
        }
    }

    // Host üzerinden troll mesajını yönlendirme (Sadece Host'ta çalışır)
    peer?.on('connection', (c) => {
        c.on('data', (d) => {
            if(d.type === 'forward_troll' && role === 'host') {
                if(d.target === myId) deleteLastBlock();
                else peer._connections.get(d.target)[0].send({type: 'troll'});
            }
        });
    });

    function deleteLastBlock() {
        if(blocks.length > 0) {
            blocks.pop();
            sendUpdate();
        }
    }

    // --- OYUN ---
    function startMatch() {
        broadcast({type: 'start'});
        beginGame();
    }

    function beginGame() {
        document.getElementById('ui-layer').style.display = 'none';
        isGaming = true;
        resize();
        spawn();
        loop();
    }

    function spawn() {
        currentBlock = { x: canvas.width/2-20, y: 0, w: 40, h: 20, color: '#0f0' };
    }

    function loop() {
        if(!isGaming) return;
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // Çizgi
        ctx.strokeStyle = '#333';
        ctx.beginPath(); ctx.moveTo(0, canvas.height - (winHeight * 20)); ctx.lineTo(canvas.width, canvas.height - (winHeight * 20)); ctx.stroke();

        currentBlock.y += 2;
        if(checkColl()) {
            blocks.push({...currentBlock, color: '#555'});
            sendUpdate();
            spawn();
            if(blocks.length >= winHeight) broadcast({type: 'win', n: myNick});
        }

        ctx.fillStyle = currentBlock.color;
        ctx.fillRect(currentBlock.x, currentBlock.y, currentBlock.w, currentBlock.h);
        
        blocks.forEach(b => {
            ctx.fillStyle = b.color;
            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = '#000'; ctx.strokeRect(b.x, b.y, b.w, b.h);
        });
        requestAnimationFrame(loop);
    }

    function checkColl() {
        if(currentBlock.y + currentBlock.h >= canvas.height) return true;
        return blocks.some(b => 
            currentBlock.x < b.x + b.w && currentBlock.x + currentBlock.w > b.x &&
            currentBlock.y + currentBlock.h >= b.y
        );
    }

    function sendUpdate() {
        players[myId].h = blocks.length / winHeight;
        broadcast({type: role === 'host' ? 'sync' : 'update', h: players[myId].h, p: players});
    }

    function updateBars() {
        let pArray = Object.keys(players).filter(id => id !== myId);
        pArray.forEach((id, i) => {
            let slot = document.getElementById(`slot-${i}`);
            if(slot) {
                slot.querySelector('.opp-name').innerText = players[id].nick;
                slot.querySelector('.opp-bar').style.height = (players[id].h * 100) + "%";
                slot.querySelector('.troll-btn').classList.remove('hidden');
            }
        });
    }

    // --- KONTROLLER ---
    function move(dir) {
        if(dir === 'L' && currentBlock.x > 0) currentBlock.x -= 20;
        if(dir === 'R' && currentBlock.x < canvas.width-40) currentBlock.x += 20;
        if(dir === 'D') currentBlock.y += 40;
    }

    document.getElementById('left').onclick = () => move('L');
    document.getElementById('right').onclick = () => move('R');
    document.getElementById('down').onclick = () => move('D');
    window.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft') move('L');
        if(e.key === 'ArrowRight') move('R');
        if(e.key === 'ArrowDown') move('D');
    });

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
</script>
</body>
</html>
