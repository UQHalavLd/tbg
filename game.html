<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower Troll: Chat & Grid Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; color: #fff; font-family: 'Poppins', sans-serif; overflow: hidden; touch-action: none; }

        /* TOAST BÄ°LDÄ°RÄ°M */
        #toast-container { position: fixed; top: 10px; right: 10px; z-index: 10001; pointer-events: none; }
        .toast { background: #0f0; color: #000; padding: 8px 15px; border-radius: 8px; font-weight: bold; margin-bottom: 5px; font-size: 12px; box-shadow: 0 4px 10px rgba(0,255,0,0.3); animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* CHAT PANELÄ° */
        #chat-trigger { position: fixed; top: 15px; left: 15px; z-index: 10002; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 50%; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        #chat-panel { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: rgba(15,15,15,0.95); border-right: 2px solid #333; z-index: 10003; transition: 0.3s; display: flex; flex-direction: column; padding: 20px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #chat-panel.active { left: 0; }
        #chat-messages { flex: 1; overflow-y: auto; margin-top: 50px; padding: 5px; font-size: 13px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #222; padding: 8px; border-radius: 8px; border-left: 3px solid #0f0; word-break: break-all; }
        .msg b { color: #0f0; font-size: 11px; display: block; }
        #chat-input-area { display: flex; gap: 5px; margin-top: 10px; }
        #chat-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; font-family: inherit; }

        /* UI KATMANLARI */
        #ui-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .card { background: #111; padding: 25px; border: 2px solid #222; text-align: center; width: 90%; max-width: 450px; border-radius: 20px; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; font-family: inherit; }
        button { width: 100%; padding: 15px; margin: 8px 0; cursor: pointer; background: #0f0; color: #000; border: none; font-weight: 900; border-radius: 12px; transition: 0.2s; }
        .btn-red { background: #ff4444; color: #fff; }

        /* LOBÄ° */
        #lobby-list { text-align: left; margin: 15px 0; background: #000; padding: 10px; border-radius: 12px; max-height: 150px; overflow-y: auto; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #111; font-size: 14px; }
        .kick-btn { background: #ff4444; color: #fff; border: none; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }

        /* OYUN */
        #main-wrapper { display: flex; width: 100vw; height: 100vh; }
        #game-container { flex: 3; position: relative; background: #080808; }
        canvas { width: 100%; height: 100%; display: block; }

        #sidebar { flex: 1; background: #000; display: flex; flex-direction: column; padding: 10px; gap: 10px; border-left: 2px solid #111; min-width: 140px; }
        .opp-slot { flex: 1; background: #0a0a0a; border: 1px solid #1a1a1a; position: relative; border-radius: 15px; overflow: hidden; display: flex; align-items: flex-end; }
        .opp-bar { width: 100%; background: linear-gradient(to top, #0f0, #006600); transition: height 0.4s; height: 0%; }
        .opp-name { position: absolute; top: 0; width: 100%; text-align: center; font-size: 10px; padding: 4px; z-index: 10; background: rgba(0,0,0,0.6); }
        .troll-btn { position: absolute; top: 35px; left: 10%; width: 80%; background: #ff0044; color: #fff; border: none; padding: 5px; font-size: 10px; border-radius: 8px; z-index: 20; cursor: pointer; }

        #hud { position: absolute; top: 15px; right: 80px; font-weight: 900; color: #0f0; z-index: 100; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; }
        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .ctrl-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.05); border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #fff; }

        @media (max-width: 700px) {
            #main-wrapper { flex-direction: column; }
            #sidebar { flex-direction: row; height: 130px; min-height: 130px; }
            #game-container { flex: 1; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="chat-trigger" onclick="toggleChat()">ðŸ’¬</div>
<div id="chat-panel">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h3 style="margin:0; color:#0f0;">CHAT</h3>
        <button onclick="toggleChat()" style="width:30px; height:30px; padding:0; margin:0;">X</button>
    </div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Mesaj yaz..." maxlength="50">
        <button onclick="sendChat()" style="width:50px; padding:0; margin:0;">></button>
    </div>
</div>

<div id="ui-layer">
    <div id="card-init" class="card">
        <h1 style="color:#0f0; margin:0;">TOWER TROLL</h1>
        <p style="font-size:11px; color:#555; margin-bottom:20px;">V3.5 + CHAT ENABLED</p>
        <input type="text" id="nick" placeholder="NICKNAME" maxlength="10">
        <button onclick="startNet('host')">ODA KUR</button>
        <button onclick="showJoin()" style="background:#222; color:#fff;">KATIL</button>
    </div>

    <div id="card-lobby" class="card hidden">
        <h2>KOD: <span id="display-code" style="color:#0f0;">----</span></h2>
        <select id="game-mode-select">
            <option value="race">ZÄ°RVE YARIÅžI (18 BLOK - 3 TROL)</option>
            <option value="time">60 SN REKABET (5 TROL)</option>
            <option value="chaos">SINIRSIZ KAOS (20 TROL)</option>
        </select>
        <div id="lobby-list"></div>
        <button onclick="launchMatch()">BAÅžLAT</button>
    </div>

    <div id="card-wait" class="card hidden">
        <h2 style="color:#0f0;">LOBÄ°DESÄ°N</h2>
        <p id="wait-msg">Kurucu bekleniyor...</p>
    </div>

    <div id="card-over" class="card hidden">
        <h1 id="winner-title" style="color:#0f0;">ZAFER!</h1>
        <div id="host-controls" class="hidden">
            <button onclick="launchMatch()">YENÄ°DEN BAÅžLAT</button>
            <button onclick="location.reload()" class="btn-red">KAPAT</button>
        </div>
        <p id="client-status" class="hidden">Kurucu bekleniyor...</p>
    </div>
</div>

<div id="main-wrapper">
    <div id="game-container">
        <div id="hud">TR: <span id="troll-val">0</span> | <span id="timer-val"></span></div>
        <canvas id="gameCanvas"></canvas>
        <div id="controls">
            <div class="ctrl-btn" onclick="move('L')">â—€</div>
            <div class="ctrl-btn" onclick="move('D')">â–¼</div>
            <div class="ctrl-btn" onclick="move('R')">â–¶</div>
        </div>
    </div>
    <div id="sidebar">
        <div class="opp-slot" id="slot0"><div class="opp-name">...</div><button class="troll-btn hidden" onclick="triggerTroll(0)">TROLLE!</button><div class="opp-bar"></div></div>
        <div class="opp-slot" id="slot1"><div class="opp-name">...</div><button class="troll-btn hidden" onclick="triggerTroll(1)">TROLLE!</button><div class="opp-bar"></div></div>
        <div class="opp-slot" id="slot2"><div class="opp-name">...</div><button class="troll-btn hidden" onclick="triggerTroll(2)">TROLLE!</button><div class="opp-bar"></div></div>
    </div>
</div>

<script>
    let peer, conn, myRole, myNick, myId, currentMode;
    let players = {}; 
    let tCount = 0, tMax = 0, gameTime = 60;
    let isLive = false;
    const GRID = 25;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let stack = [], active = null;

    // CHAT MANTIÄžI
    function toggleChat() { document.getElementById('chat-panel').classList.toggle('active'); }
    
    function sendChat() {
        const inp = document.getElementById('chat-input');
        if(!inp.value.trim()) return;
        const msgData = { type: 'chat', n: myNick, m: inp.value };
        broadcast(msgData);
        addMsg(myNick, inp.value);
        inp.value = '';
    }

    function addMsg(name, text) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${name}</b>${text}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        if(!document.getElementById('chat-panel').classList.contains('active')) {
            showToast(name + ": " + text.substring(0,15) + "...");
        }
    }

    // NETWORK
    function showToast(m) {
        const t = document.createElement('div');
        t.className = 'toast'; t.innerText = m;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function showJoin() {
        const code = prompt("Oda Kodu:");
        if(code) startNet('join', code.toUpperCase());
    }

    function startNet(role, code) {
        myRole = role;
        myNick = document.getElementById('nick').value || "OYUNCU";
        const finalID = (role === 'host') ? Math.floor(1000 + Math.random()*9000).toString() : null;
        peer = new Peer(role === 'host' ? finalID : null);

        peer.on('open', id => {
            myId = id;
            if(role === 'host') {
                document.getElementById('card-init').classList.add('hidden');
                document.getElementById('card-lobby').classList.remove('hidden');
                document.getElementById('display-code').innerText = id;
                players[id] = {n: myNick, h: 0};
                updateLobbyUI();
            } else {
                let c = peer.connect(code);
                handleConnection(c);
            }
        });
        peer.on('connection', handleConnection);
    }

    function handleConnection(c) {
        c.on('open', () => {
            if(myRole === 'join') {
                c.send({type: 'join', n: myNick});
                document.getElementById('card-init').classList.add('hidden');
                document.getElementById('card-wait').classList.remove('hidden');
            }
            c.on('data', d => {
                if(d.type === 'chat') addMsg(d.n, d.m);
                if(d.type === 'join' && myRole === 'host') {
                    players[c.peer] = {n: d.n, h: 0};
                    showToast(d.n + " katÄ±ldÄ±!");
                    syncAll();
                }
                if(d.type === 'sync') { players = d.ps; updateLobbyUI(); updateBars(); }
                if(d.type === 'kick') { alert("AtÄ±ldÄ±n!"); location.reload(); }
                if(d.type === 'start') countdownStart(d.m);
                if(d.type === 'troll_hit') { stack.pop(); showToast("TROL SÄ°LDÄ°!"); report(); }
                if(d.type === 'victory') showVictory(d.n);
                if(d.type === 'troll_req' && myRole === 'host') {
                    if(d.target === myId) { stack.pop(); report(); }
                    else { let tc = peer.connections[d.target][0]; if(tc) tc.send({type: 'troll_hit'}); }
                }
            });
        });
    }

    function syncAll() { if(myRole === 'host') broadcast({type: 'sync', ps: players}); updateLobbyUI(); }

    function kickPlayer(id) {
        let c = peer.connections[id][0];
        if(c) c.send({type: 'kick'});
        delete players[id];
        syncAll();
    }

    function updateLobbyUI() {
        const list = document.getElementById('lobby-list');
        list.innerHTML = '';
        Object.keys(players).forEach(id => {
            const div = document.createElement('div');
            div.className = 'player-item';
            div.innerHTML = `<span>${players[id].n}</span>`;
            if(myRole === 'host' && id !== myId) {
                const btn = document.createElement('button');
                btn.className = 'kick-btn'; btn.innerText = 'X';
                btn.onclick = () => kickPlayer(id);
                div.appendChild(btn);
            }
            list.appendChild(div);
        });
    }

    function broadcast(data) {
        if(myRole === 'host') {
            Object.values(peer.connections).forEach(conns => conns[0].send(data));
        } else {
            let hostConn = peer.connections[Object.keys(peer.connections)[0]][0];
            if(hostConn) hostConn.send(data);
        }
    }

    function launchMatch() {
        let m = document.getElementById('game-mode-select').value;
        broadcast({type: 'start', m: m});
        countdownStart(m);
    }

    function countdownStart(m) {
        isLive = false;
        document.getElementById('ui-layer').style.display = 'flex';
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById('card-wait').classList.remove('hidden');
        let c = 3;
        const timer = setInterval(() => {
            document.getElementById('wait-msg').innerText = "GERÄ° SAYIM: " + c;
            c--;
            if(c < 0) { clearInterval(timer); startGame(m); }
        }, 1000);
    }

    function startGame(m) {
        currentMode = m;
        document.getElementById('ui-layer').style.display = 'none';
        isLive = true; stack = []; gameTime = 60;
        tMax = (m === 'race') ? 3 : (m === 'time' ? 5 : 20);
        tCount = tMax;
        document.getElementById('troll-val').innerText = tCount;

        const regen = setInterval(() => {
            if(!isLive) { clearInterval(regen); return; }
            if(tCount < tMax) { tCount++; document.getElementById('troll-val').innerText = tCount; }
        }, 3000);

        if(m === 'time') {
            const clock = setInterval(() => {
                if(!isLive) { clearInterval(clock); return; }
                gameTime--;
                document.getElementById('timer-val').innerText = gameTime + "s";
                if(gameTime <= 0 && myRole === 'host') checkTimeWinner();
            }, 1000);
        } else { document.getElementById('timer-val').innerText = ""; }

        resize(); spawn(); loop();
    }

    function spawn() {
        let gridX = Math.floor((canvas.width/2 - 25) / GRID) * GRID;
        active = { x: gridX, y: 0, w: 50, h: 25 };
    }

    function loop() {
        if(!isLive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(currentMode === 'race') {
            ctx.strokeStyle = '#222';
            ctx.strokeRect(0, canvas.height - (18 * 25), canvas.width, 1);
        }
        active.y += 2.5;
        if(active.y + active.h >= canvas.height || stack.some(b => active.x < b.x + b.w && active.x + active.w > b.x && active.y + active.h >= b.y)) {
            active.y = Math.floor(active.y / GRID) * GRID;
            stack.push({...active});
            report();
            if(currentMode === 'race' && stack.length >= 18) {
                broadcast({type: 'victory', n: myNick});
                showVictory(myNick);
            }
            spawn();
        }
        ctx.fillStyle = '#0f0'; ctx.fillRect(active.x, active.y, active.w, active.h);
        ctx.fillStyle = '#004400';
        stack.forEach(b => { ctx.fillRect(b.x, b.y, b.w, b.h); ctx.strokeRect(b.x, b.y, b.w, b.h); });
        requestAnimationFrame(loop);
    }

    function move(d) {
        if(!active) return;
        if(d === 'L' && active.x > 0) active.x -= GRID;
        if(d === 'R' && active.x < canvas.width - 50) active.x += GRID;
        if(d === 'D') active.y += 50;
    }

    function triggerTroll(idx) {
        if(tCount <= 0) return;
        let others = Object.keys(players).filter(id => id !== myId);
        if(others[idx]) { tCount--; document.getElementById('troll-val').innerText = tCount; broadcast({type: 'troll_req', target: others[idx]}); }
    }

    function report() {
        players[myId].h = stack.length / 18;
        broadcast({type: 'sync', ps: players});
    }

    function updateBars() {
        let others = Object.keys(players).filter(id => id !== myId);
        others.forEach((id, i) => {
            const slot = document.getElementById('slot'+i);
            if(slot) {
                slot.querySelector('.opp-name').innerText = players[id].n;
                slot.querySelector('.opp-bar').style.height = Math.min(100, (players[id].h * 100)) + "%";
                slot.querySelector('.troll-btn').classList.remove('hidden');
            }
        });
    }

    function showVictory(n) {
        isLive = false;
        document.getElementById('ui-layer').style.display = 'flex';
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById('card-over').classList.remove('hidden');
        document.getElementById('winner-title').innerText = n + " KAZANDI!";
        if(myRole === 'host') document.getElementById('host-controls').classList.remove('hidden');
        else document.getElementById('client-status').classList.remove('hidden');
    }

    function checkTimeWinner() {
        let best = null, max = -1;
        Object.values(players).forEach(p => { if(p.h > max) { max = p.h; best = p.n; }});
        broadcast({type: 'victory', n: best});
        showVictory(best);
    }

    function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
    window.addEventListener('resize', resize);
    document.getElementById('chat-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendChat(); });
</script>
</body>
</html>
